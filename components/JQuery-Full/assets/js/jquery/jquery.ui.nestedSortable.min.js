/*
 * jQuery UI Nested Sortable
 * v 1.2.2 / 19 feb 2011
 * http://mjsarfatti.com/sandbox/nestedSortable
 *
 * Depends:
 *	 jquery.ui.sortable.js 1.8+
 *
 * License CC BY-SA 3.0
 * Copyright 2010-2011, Manuele J Sarfatti
 */
(function(a){a.widget("ui.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",noJumpFix:"0"},_create:function(){if(this.noJumpFix==false){this.element.height(this.element.height())}this.element.data("sortable",this.element.data("nestedSortable"));return a.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(f){this.position=this._generatePosition(f);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var g=this.options,d=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-f.pageY<g.scrollSensitivity){this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+g.scrollSpeed}else{if(f.pageY-this.overflowOffset.top<g.scrollSensitivity){this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-g.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-f.pageX<g.scrollSensitivity){this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+g.scrollSpeed}else{if(f.pageX-this.overflowOffset.left<g.scrollSensitivity){this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-g.scrollSpeed}}}else{if(f.pageY-a(document).scrollTop()<g.scrollSensitivity){d=a(document).scrollTop(a(document).scrollTop()-g.scrollSpeed)}else{if(a(window).height()-(f.pageY-a(document).scrollTop())<g.scrollSensitivity){d=a(document).scrollTop(a(document).scrollTop()+g.scrollSpeed)}}if(f.pageX-a(document).scrollLeft()<g.scrollSensitivity){d=a(document).scrollLeft(a(document).scrollLeft()-g.scrollSpeed)}else{if(a(window).width()-(f.pageX-a(document).scrollLeft())<g.scrollSensitivity){d=a(document).scrollLeft(a(document).scrollLeft()+g.scrollSpeed)}}}if(d!==false&&a.ui.ddmanager&&!g.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,f)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}for(var c=this.items.length-1;c>=0;c--){var e=this.items[c],b=e.item[0],h=this._intersectsWithPointer(e);if(!h){continue}if(b!=this.currentItem[0]&&this.placeholder[h==1?"next":"prev"]()[0]!=b&&!a.ui.contains(this.placeholder[0],b)&&(this.options.type=="semi-dynamic"?!a.ui.contains(this.element[0],b):true)){this.direction=h==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(e)){this._rearrange(f,e)}else{break}this._clearEmpty(b);this._trigger("change",f,this._uiHash());break}}itemBefore=this.placeholder[0].previousSibling;while(itemBefore!=null){if(itemBefore.nodeType==1&&itemBefore!=this.currentItem[0]){break}else{itemBefore=itemBefore.previousSibling}}parentItem=this.placeholder[0].parentNode.parentNode;newList=document.createElement(g.listType);if(parentItem!=null&&parentItem.nodeName=="LI"&&a(parentItem).closest(".ui-sortable").length&&this.positionAbs.left<a(parentItem).offset().left){a(parentItem).after(this.placeholder[0]);this._clearEmpty(parentItem)}else{if(itemBefore!=null&&itemBefore.nodeName=="LI"&&this.positionAbs.left>a(itemBefore).offset().left+this.options.tabSize){if(!(a(itemBefore).hasClass(this.options.disableNesting))){if(a(this.placeholder[0]).hasClass(this.options.errorClass)){a(this.placeholder[0]).css("marginLeft",0).removeClass(this.options.errorClass)}if(itemBefore.children[1]==null){itemBefore.appendChild(newList)}itemBefore.children[1].appendChild(this.placeholder[0])}else{a(this.placeholder[0]).addClass(this.options.errorClass).css("marginLeft",this.options.tabSize)}}else{if(itemBefore!=null){if(a(this.placeholder[0]).hasClass(this.options.errorClass)){a(this.placeholder[0]).css("marginLeft",0).removeClass(this.options.errorClass)}a(itemBefore).after(this.placeholder[0])}else{if(a(this.placeholder[0]).hasClass(this.options.errorClass)){a(this.placeholder[0]).css("marginLeft",0).removeClass(this.options.errorClass)}}}}this._contactContainers(f);if(a.ui.ddmanager){a.ui.ddmanager.drag(this,f)}this._trigger("sort",f,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},serialize:function(d){var b=this._getItemsAsjQuery(d&&d.connected);var c=[];d=d||{};a(b).each(function(){var f=(a(d.item||this).attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));var e=(a(d.item||this).parent(d.listType).parent("li").attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));if(f){c.push((d.key||f[1]+"["+(d.key&&d.expression?f[1]:f[2])+"]")+"="+(e?(d.key&&d.expression?e[1]:e[2]):"root"))}});if(!c.length&&d.key){c.push(d.key+"=")}return c.join("&")},toHierarchy:function(e){e=e||{};var d=e.startDepthCount||0;var c=[];a(this.element).children("li").each(function(){var f=b(a(this));c.push(f)});return c;function b(f){var h=a(f).attr("id");var g={id:h};if(a(f).children(e.listType).children("li").length>0){g.children=[];a(f).children(e.listType).children("li").each(function(){var i=b(a(this));g.children.push(i)})}return g}},toArray:function(f){f=f||{};var c=f.startDepthCount||0;var b=[];var d=2;b.push({item_id:"root",parent_id:"none",depth:c,left:"1",right:(a("li",this.element).length+1)*2});a(this.element).children("li").each(function(){d=e(a(this),c+1,d)});return b;function e(g,i,h){right=h+1;if(a(g).children(f.listType).children("li").length>0){i++;a(g).children(f.listType).children("li").each(function(){right=e(a(this),i,right)});i--}id=a(g).attr("id").match(f.expression||(/(.+)[-=_](.+)/));if(i===c+1){pid="root"}else{parentItem=a(g).parent(f.listType).parent("li").attr("id").match(f.expression||(/(.+)[-=_](.+)/));pid=parentItem[2]}b.push({item_id:id[2],parent_id:pid,depth:i,left:h,right:right});return h=right+1}},_createPlaceholder:function(d){var c=d||this,e=c.options;if(!e.placeholder||e.placeholder.constructor==String){var b=e.placeholder;e.placeholder={element:function(){var f=a(document.createElement(c.currentItem[0].nodeName)).addClass(b||c.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];if(!b){f.style.visibility="hidden"}return f},update:function(f,g){if(b&&!e.forcePlaceholderSize){return}if(!g.height()||g.css("height")=="auto"){g.height(c.currentItem.height())}if(!g.width()){g.width(c.currentItem.width())}}}}c.placeholder=a(e.placeholder.element.call(c.element,c.currentItem));c.currentItem.after(c.placeholder);e.placeholder.update(c,c.placeholder)},_clear:function(d,e){a.ui.sortable.prototype._clear.apply(this,arguments);for(var b=this.items.length-1;b>=0;b--){var c=this.items[b].item[0];this._clearEmpty(c)}return true},_clearEmpty:function(b){if(b.children[1]&&b.children[1].children.length==0){b.removeChild(b.children[1])}}}));a.ui.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.ui.nestedSortable.prototype.options)})(jQuery);
