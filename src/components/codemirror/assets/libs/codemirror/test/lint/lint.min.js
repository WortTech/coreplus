var fs=require("fs"),acorn=require("./acorn.js"),walk=require("./walk.js");var scopePasser=walk.make({ScopeBody:function(b,a,d){d(b,b.scope)}});function checkFile(h){var f=fs.readFileSync(h,"utf8"),p;if(p=f.match(/[\x00-\x08\x0b\x0c\x0e-\x19\uFEFF\t]|[ \t]\n/)){var c;if(p[0]=="\t"){c="Found tab character"}else{if(p[0].indexOf("\n")>-1){c="Trailing whitespace"}else{c="Undesirable character "+p[0].charCodeAt(0)}}var d=acorn.getLineInfo(f,p.index);fail(c+" at line "+d.line+", column "+d.column,{source:h})}try{var l=acorn.parse(f,{locations:true,ecmaVersion:3,strictSemicolons:true,allowTrailingCommas:false,forbidReserved:true,sourceFile:h})}catch(k){fail(k.message,{source:h});return}var n=[];walk.simple(l,{ScopeBody:function(i,e){i.scope=e;n.push(e)}},walk.scopeVisitor,{vars:Object.create(null)});var b=Object.create(null);function g(e,i){for(var q=i;q;q=q.prev){if(e in q.vars){return true}}}function m(i,e){if(i.type=="Identifier"&&!(i.name in b)&&!g(i.name,e)){b[i.name]=true;fail("Assignment to global variable",i.loc)}}walk.simple(l,{UpdateExpression:function(i,e){m(i.argument,e)},AssignmentExpression:function(i,e){m(i.left,e)},Identifier:function(i,e){for(var q=e;q;q=q.prev){if(i.name in q.vars){q.vars[i.name].used=true;return}}},FunctionExpression:function(e){if(e.id){fail("Named function expression",e.loc)}}},scopePasser);for(var j=0;j<n.length;++j){var o=n[j];for(var a in o.vars){var d=o.vars[a];if(!d.used&&d.type!="catch clause"&&d.type!="function name"&&a.charAt(0)!="_"){fail("Unused "+d.type+" "+a,d.node.loc)}}}}var failed=false;function fail(a,b){if(b.start){a+=" ("+b.start.line+":"+b.start.column+")"}console.log(b.source+": "+a);failed=true}function checkDir(a){fs.readdirSync(a).forEach(function(b){var c=a+"/"+b;if(/\.js$/.test(b)){checkFile(c)}else{if(fs.lstatSync(c).isDirectory()){checkDir(c)}}})}exports.checkDir=checkDir;exports.checkFile=checkFile;exports.success=function(){return !failed};