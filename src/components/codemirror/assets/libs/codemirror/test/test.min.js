var Pos=CodeMirror.Pos;function forEach(a,c){for(var b=0,d=a.length;b<d;++b){c(a[b])}}function addDoc(b,e,a){var f=[],c="";for(var d=0;d<e;++d){c+="x"}for(var d=0;d<a;++d){f.push(c)}b.setValue(f.join("\n"))}function byClassName(b,a){if(b.getElementsByClassName){return b.getElementsByClassName(a)}var e=[],d=new RegExp("\\b"+a+"\\b");function c(f){if(f.nodeType==3){return}if(d.test(f.className)){e.push(f)}for(var g=0,h=f.childNodes.length;g<h;++g){c(f.childNodes[g])}}c(b);return e}var ie_lt8=/MSIE [1-7]\b/.test(navigator.userAgent);var mac=/Mac/.test(navigator.platform);var phantom=/PhantomJS/.test(navigator.userAgent);var opera=/Opera\/\./.test(navigator.userAgent);var opera_version=opera&&navigator.userAgent.match(/Version\/(\d+\.\d+)/);if(opera_version){opera_version=Number(opera_version)}var opera_lt10=opera&&(!opera_version||opera_version<10);test("core_fromTextArea",function(){var b=document.getElementById("code");b.value="CONTENT";var a=CodeMirror.fromTextArea(b);is(!b.offsetHeight);eq(a.getValue(),"CONTENT");a.setValue("foo\nbar");eq(a.getValue(),"foo\nbar");a.save();is(/^foo\r?\nbar$/.test(b.value));a.setValue("xxx");a.toTextArea();is(b.offsetHeight);eq(b.value,"xxx")});testCM("getRange",function(a){eq(a.getLine(0),"1234");eq(a.getLine(1),"5678");eq(a.getLine(2),null);eq(a.getLine(-1),null);eq(a.getRange(Pos(0,0),Pos(0,3)),"123");eq(a.getRange(Pos(0,-1),Pos(0,200)),"1234");eq(a.getRange(Pos(0,2),Pos(1,2)),"34\n56");eq(a.getRange(Pos(1,2),Pos(100,0)),"78")},{value:"1234\n5678"});testCM("replaceRange",function(a){eq(a.getValue(),"");a.replaceRange("foo\n",Pos(0,0));eq(a.getValue(),"foo\n");a.replaceRange("a\nb",Pos(0,1));eq(a.getValue(),"fa\nboo\n");eq(a.lineCount(),3);a.replaceRange("xyzzy",Pos(0,0),Pos(1,1));eq(a.getValue(),"xyzzyoo\n");a.replaceRange("abc",Pos(0,0),Pos(10,0));eq(a.getValue(),"abc");eq(a.lineCount(),1)});testCM("selection",function(a){a.setSelection(Pos(0,4),Pos(2,2));is(a.somethingSelected());eq(a.getSelection(),"11\n222222\n33");eqPos(a.getCursor(false),Pos(2,2));eqPos(a.getCursor(true),Pos(0,4));a.setSelection(Pos(1,0));is(!a.somethingSelected());eq(a.getSelection(),"");eqPos(a.getCursor(true),Pos(1,0));a.replaceSelection("abc");eq(a.getSelection(),"abc");eq(a.getValue(),"111111\nabc222222\n333333");a.replaceSelection("def","end");eq(a.getSelection(),"");eqPos(a.getCursor(true),Pos(1,3));a.setCursor(Pos(2,1));eqPos(a.getCursor(true),Pos(2,1));a.setCursor(1,2);eqPos(a.getCursor(true),Pos(1,2))},{value:"111111\n222222\n333333"});testCM("extendSelection",function(a){a.setExtending(true);addDoc(a,10,10);a.setSelection(Pos(3,5));eqPos(a.getCursor("head"),Pos(3,5));eqPos(a.getCursor("anchor"),Pos(3,5));a.setSelection(Pos(2,5),Pos(5,5));eqPos(a.getCursor("head"),Pos(5,5));eqPos(a.getCursor("anchor"),Pos(2,5));eqPos(a.getCursor("start"),Pos(2,5));eqPos(a.getCursor("end"),Pos(5,5));a.setSelection(Pos(5,5),Pos(2,5));eqPos(a.getCursor("head"),Pos(2,5));eqPos(a.getCursor("anchor"),Pos(5,5));eqPos(a.getCursor("start"),Pos(2,5));eqPos(a.getCursor("end"),Pos(5,5));a.extendSelection(Pos(3,2));eqPos(a.getCursor("head"),Pos(3,2));eqPos(a.getCursor("anchor"),Pos(5,5));a.extendSelection(Pos(6,2));eqPos(a.getCursor("head"),Pos(6,2));eqPos(a.getCursor("anchor"),Pos(5,5));a.extendSelection(Pos(6,3),Pos(6,4));eqPos(a.getCursor("head"),Pos(6,4));eqPos(a.getCursor("anchor"),Pos(5,5));a.extendSelection(Pos(0,3),Pos(0,4));eqPos(a.getCursor("head"),Pos(0,3));eqPos(a.getCursor("anchor"),Pos(5,5));a.extendSelection(Pos(4,5),Pos(6,5));eqPos(a.getCursor("head"),Pos(6,5));eqPos(a.getCursor("anchor"),Pos(4,5));a.setExtending(false);a.extendSelection(Pos(0,3),Pos(0,4));eqPos(a.getCursor("head"),Pos(0,4));eqPos(a.getCursor("anchor"),Pos(0,3))});testCM("lines",function(a){eq(a.getLine(0),"111111");eq(a.getLine(1),"222222");eq(a.getLine(-1),null);a.removeLine(1);a.setLine(1,"abc");eq(a.getValue(),"111111\nabc")},{value:"111111\n222222\n333333"});testCM("indent",function(a){a.indentLine(1);eq(a.getLine(1),"   blah();");a.setOption("indentUnit",8);a.indentLine(1);eq(a.getLine(1),"\tblah();");a.setOption("indentUnit",10);a.setOption("tabSize",4);a.indentLine(1);eq(a.getLine(1),"\t\t  blah();")},{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:true,tabSize:8});test("core_defaults",function(){var e={},b=CodeMirror.defaults;for(var d in b){e[d]=b[d]}b.indentUnit=5;b.value="uu";b.enterMode="keep";b.tabindex=55;var c=document.getElementById("testground"),a=CodeMirror(c);try{eq(a.getOption("indentUnit"),5);a.setOption("indentUnit",10);eq(b.indentUnit,5);eq(a.getValue(),"uu");eq(a.getOption("enterMode"),"keep");eq(a.getInputField().tabIndex,55)}finally{for(var d in e){b[d]=e[d]}c.removeChild(a.getWrapperElement())}});testCM("lineInfo",function(a){eq(a.lineInfo(-1),null);var d=document.createElement("span");var b=a.setGutterMarker(1,"FOO",d);var c=a.lineInfo(1);eq(c.text,"222222");eq(c.gutterMarkers.FOO,d);eq(c.line,1);eq(a.lineInfo(2).gutterMarkers,null);a.setGutterMarker(b,"FOO",null);eq(a.lineInfo(1).gutterMarkers,null);a.setGutterMarker(1,"FOO",d);a.setGutterMarker(0,"FOO",d);a.clearGutter("FOO");eq(a.lineInfo(0).gutterMarkers,null);eq(a.lineInfo(1).gutterMarkers,null)},{value:"111111\n222222\n333333"});testCM("coords",function(a){a.setSize(null,100);addDoc(a,32,200);var c=a.charCoords(Pos(0,0));var d=a.charCoords(Pos(200,30));is(c.left<d.left);is(c.top<d.top);is(c.top<c.bottom);a.scrollTo(null,100);var b=a.charCoords(Pos(0,0));is(c.top>b.top);eq(c.left,b.left)});testCM("coordsChar",function(a){addDoc(a,35,70);for(var c=0;c<=35;c+=5){for(var b=0;b<70;b+=5){a.setCursor(b,c);var d=a.charCoords(Pos(b,c));var e=a.coordsChar({left:d.left,top:d.top+5});eqPos(e,Pos(b,c))}}});testCM("posFromIndex",function(a){a.setValue("This function should\nconvert a zero based index\nto line and ch.");var c=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}];for(var d=0;d<c.length;d++){var b=c[d];var e=a.posFromIndex(b.index);eq(e.line,b.line);eq(e.ch,b.ch);if(b.index>=0&&b.index<64){eq(a.indexFromPos(e),b.index)}}});testCM("undo",function(a){a.setLine(0,"def");eq(a.historySize().undo,1);a.undo();eq(a.getValue(),"abc");eq(a.historySize().undo,0);eq(a.historySize().redo,1);a.redo();eq(a.getValue(),"def");eq(a.historySize().undo,1);eq(a.historySize().redo,0);a.setValue("1\n\n\n2");a.clearHistory();eq(a.historySize().undo,0);for(var b=0;b<20;++b){a.replaceRange("a",Pos(0,0));a.replaceRange("b",Pos(3,0))}eq(a.historySize().undo,40);for(var b=0;b<40;++b){a.undo()}eq(a.historySize().redo,40);eq(a.getValue(),"1\n\n\n2")},{value:"abc"});testCM("undoDepth",function(a){a.replaceRange("d",Pos(0));a.replaceRange("e",Pos(0));a.replaceRange("f",Pos(0));a.undo();a.undo();a.undo();eq(a.getValue(),"abcd")},{value:"abc",undoDepth:2});testCM("undoDoesntClearValue",function(a){a.undo();eq(a.getValue(),"x")},{value:"x"});testCM("undoMultiLine",function(a){a.operation(function(){a.replaceRange("x",Pos(0,0));a.replaceRange("y",Pos(1,0))});a.undo();eq(a.getValue(),"abc\ndef\nghi");a.operation(function(){a.replaceRange("y",Pos(1,0));a.replaceRange("x",Pos(0,0))});a.undo();eq(a.getValue(),"abc\ndef\nghi");a.operation(function(){a.replaceRange("y",Pos(2,0));a.replaceRange("x",Pos(1,0));a.replaceRange("z",Pos(2,0))});a.undo();eq(a.getValue(),"abc\ndef\nghi",3)},{value:"abc\ndef\nghi"});testCM("undoComposite",function(a){a.replaceRange("y",Pos(1));a.operation(function(){a.replaceRange("x",Pos(0));a.replaceRange("z",Pos(2))});eq(a.getValue(),"ax\nby\ncz\n");a.undo();eq(a.getValue(),"a\nby\nc\n");a.undo();eq(a.getValue(),"a\nb\nc\n");a.redo();a.redo();eq(a.getValue(),"ax\nby\ncz\n")},{value:"a\nb\nc\n"});testCM("undoSelection",function(a){a.setSelection(Pos(0,2),Pos(0,4));a.replaceSelection("");a.setCursor(Pos(1,0));a.undo();eqPos(a.getCursor(true),Pos(0,2));eqPos(a.getCursor(false),Pos(0,4));a.setCursor(Pos(1,0));a.redo();eqPos(a.getCursor(true),Pos(0,2));eqPos(a.getCursor(false),Pos(0,2))},{value:"abcdefgh\n"});testCM("markTextSingleLine",function(a){forEach([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],function(d){a.setValue("1234567890");var b=a.markText(Pos(0,3),Pos(0,6),{className:"foo"});a.replaceRange(d.c,Pos(0,d.a),Pos(0,d.b));var c=b.find();eq(c&&c.from.ch,d.f);eq(c&&c.to.ch,d.t)})});testCM("markTextMultiLine",function(a){function b(c){return c&&Pos(c[0],c[1])}forEach([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,0],b:[0,5],c:"foo\n",f:[1,0],t:[3,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],function(e){a.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var c=a.markText(Pos(0,5),Pos(2,5),{className:"CodeMirror-matchingbracket"});a.replaceRange(e.c,b(e.a),b(e.b));var d=c.find();eqPos(d&&d.from,b(e.f));eqPos(d&&d.to,b(e.t))})});testCM("markTextUndo",function(a){var f,e,c;f=a.markText(Pos(0,1),Pos(0,3),{className:"CodeMirror-matchingbracket"});e=a.markText(Pos(0,0),Pos(2,1),{className:"CodeMirror-matchingbracket"});c=a.setBookmark(Pos(1,5));a.operation(function(){a.replaceRange("foo",Pos(0,2));a.replaceRange("bar\nbaz\nbug\n",Pos(2,0),Pos(3,0))});var g=a.getValue();a.setValue("");eq(f.find(),null);eq(e.find(),null);eq(c.find(),null);a.undo();eqPos(c.find(),Pos(1,5),"still there");a.undo();var d=f.find(),b=e.find();eqPos(d.from,Pos(0,1));eqPos(d.to,Pos(0,3));eqPos(b.from,Pos(0,0));eqPos(b.to,Pos(2,1));eqPos(c.find(),Pos(1,5));a.redo();a.redo();eq(c.find(),null);a.undo();eqPos(c.find(),Pos(1,5));eq(a.getValue(),g)},{value:"1234\n56789\n00\n"});testCM("markTextStayGone",function(a){var b=a.markText(Pos(0,0),Pos(0,1));a.replaceRange("hi",Pos(0,2));b.clear();a.undo();eq(b.find(),null)},{value:"hello"});testCM("undoPreservesNewMarks",function(a){a.markText(Pos(0,3),Pos(0,4));a.markText(Pos(1,1),Pos(1,3));a.replaceRange("",Pos(0,3),Pos(3,1));var c=a.markText(Pos(0,0),Pos(0,1));var e=a.markText(Pos(0,5),Pos(0,6));var b=a.markText(Pos(0,2),Pos(0,4));a.undo();eqPos(c.find().from,Pos(0,0));eqPos(c.find().to,Pos(0,1));eqPos(e.find().from,Pos(3,3));eqPos(e.find().to,Pos(3,4));eqPos(b.find().from,Pos(0,2));eqPos(b.find().to,Pos(3,2));var d=a.findMarksAt(Pos(2,2));eq(d.length,1);eq(d[0],b)},{value:"aaaa\nbbbb\ncccc\ndddd"});testCM("markClearBetween",function(a){a.setValue("aaa\nbbb\nccc\nddd\n");a.markText(Pos(0,0),Pos(2));a.replaceRange("aaa\nbbb\nccc",Pos(0,0),Pos(2));eq(a.findMarksAt(Pos(1,1)).length,0)});testCM("bookmark",function(a){function b(c){return c&&Pos(c[0],c[1])}forEach([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]},{bm:[1,9],a:[1,1],b:[1,1],c:"\n",d:[2,8]}],function(d){a.setValue("1234567890\n1234567890\n1234567890");var c=a.setBookmark(b(d.bm)||Pos(1,5));a.replaceRange(d.c,b(d.a),b(d.b));eqPos(c.find(),b(d.d))})});testCM("bookmarkInsertLeft",function(a){var b=a.setBookmark(Pos(0,2),{insertLeft:false});var c=a.setBookmark(Pos(0,2),{insertLeft:true});a.setCursor(Pos(0,2));a.replaceSelection("hi");eqPos(b.find(),Pos(0,2));eqPos(c.find(),Pos(0,4));a.replaceRange("",Pos(0,4),Pos(0,5));a.replaceRange("",Pos(0,2),Pos(0,4));a.replaceRange("",Pos(0,1),Pos(0,2));eqPos(b.find(),Pos(0,1));eqPos(c.find(),Pos(0,1))},{value:"abcdef"});testCM("getAllMarks",function(b){addDoc(b,10,10);var e=b.setBookmark(Pos(0,2));var d=b.markText(Pos(0,2),Pos(3,2));var c=b.markText(Pos(1,2),Pos(1,8));var a=b.markText(Pos(8,0),Pos(9,0));eq(b.getAllMarks().length,4);e.clear();c.clear();eq(b.getAllMarks().length,2)});testCM("bug577",function(a){a.setValue("a\nb");a.clearHistory();a.setValue("fooooo");a.undo()});testCM("scrollSnap",function(a){a.setSize(100,100);addDoc(a,200,200);a.setCursor(Pos(100,180));var b=a.getScrollInfo();is(b.left>0&&b.top>0);a.setCursor(Pos(0,0));b=a.getScrollInfo();is(b.left==0&&b.top==0,"scrolled clean to top");a.setCursor(Pos(100,180));a.setCursor(Pos(199,0));b=a.getScrollInfo();is(b.left==0&&b.top+2>b.height-a.getScrollerElement().clientHeight,"scrolled clean to bottom")});testCM("selectionPos",function(o){if(phantom){return}o.setSize(100,100);addDoc(o,200,100);o.setSelection(Pos(1,100),Pos(98,100));var h=o.charCoords(Pos(0,200),"local").left;var n=(o.charCoords(Pos(99)).top-o.charCoords(Pos(0)).top)/100;o.scrollTo(0,0);var l=byClassName(o.getWrapperElement(),"CodeMirror-selected");var p=o.getWrapperElement().getBoundingClientRect();var b,j,c;for(var f=0,k=l.length;f<k;++f){var g=l[f].getBoundingClientRect();var d=g.left-p.left<30;var a=g.right-g.left;var m=g.right-p.left>0.8*h;if(d&&m){b=true;is(g.bottom-g.top>90*n,"middle high");is(a>0.9*h,"middle wide")}else{is(a>0.4*h,"top/bot wide enough");is(a<0.6*h,"top/bot slim enough");if(d){c=true;is(g.top-p.top>96*n,"bot below")}else{if(m){j=true;is(g.top-p.top<2.1*n,"top above")}}}}is(j&&c&&b,"all parts")},null);testCM("restoreHistory",function(a){a.setValue("abc\ndef");a.setLine(1,"hello");a.setLine(0,"goop");a.undo();var b=a.getValue(),c=a.getHistory();if(window.JSON){c=JSON.parse(JSON.stringify(c))}eq(b,"abc\nhello");a.setValue("");a.clearHistory();eq(a.historySize().undo,0);a.setValue(b);a.setHistory(c);a.redo();eq(a.getValue(),"goop\nhello");a.undo();a.undo();eq(a.getValue(),"abc\ndef")});testCM("doubleScrollbar",function(a){var d=document.body.appendChild(document.createElement("p"));d.style.cssText="height: 50px; overflow: scroll; width: 50px";var c=d.offsetWidth+1-d.clientWidth;document.body.removeChild(d);if(c<2){return}a.setSize(null,100);addDoc(a,1,300);var b=a.getWrapperElement();is(b.offsetWidth-byClassName(b,"CodeMirror-lines")[0].offsetWidth<=c*1.5)});testCM("weirdLinebreaks",function(a){a.setValue("foo\nbar\rbaz\r\nquux\n\rplop");is(a.getValue(),"foo\nbar\nbaz\nquux\n\nplop");is(a.lineCount(),6);a.setValue("\n\n");is(a.lineCount(),3)});testCM("setSize",function(a){a.setSize(100,100);var b=a.getWrapperElement();is(b.offsetWidth,100);is(b.offsetHeight,100);a.setSize("100%","3em");is(b.style.width,"100%");is(b.style.height,"3em");a.setSize(null,40);is(b.style.width,"100%");is(b.style.height,"40px")});function foldLines(a,d,b,c){return a.markText(Pos(d,0),Pos(b-1),{inclusiveLeft:true,inclusiveRight:true,collapsed:true,clearOnEnter:c})}testCM("collapsedLines",function(a){addDoc(a,4,10);var c=foldLines(a,4,5),b=0;CodeMirror.on(c,"clear",function(){b++});a.setCursor(Pos(3,0));CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),Pos(5,0));a.setLine(3,"abcdefg");a.setCursor(Pos(3,6));CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),Pos(5,4));a.setLine(3,"ab");a.setCursor(Pos(3,2));CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),Pos(5,2));a.operation(function(){c.clear();c.clear()});eq(b,1)});testCM("collapsedRangeCoordsChar",function(a){var d=a.charCoords(Pos(1,3));d.left+=2;d.top+=2;var e={collapsed:true,inclusiveLeft:true,inclusiveRight:true};var c=a.markText(Pos(0,0),Pos(2,0),e);eqPos(a.coordsChar(d),Pos(3,3));c.clear();var c=a.markText(Pos(0,0),Pos(1,1),e);var b=a.markText(Pos(1,1),Pos(2,0),e);eqPos(a.coordsChar(d),Pos(3,3));c.clear();b.clear();var c=a.markText(Pos(0,0),Pos(1,6),e);eqPos(a.coordsChar(d),Pos(3,3))},{value:"123456\nabcdef\nghijkl\nmnopqr\n"});testCM("hiddenLinesAutoUnfold",function(a){var c=foldLines(a,1,3,true),b=0;CodeMirror.on(c,"clear",function(){b++});a.setCursor(Pos(3,0));eq(b,0);a.execCommand("goCharLeft");eq(b,1);c=foldLines(a,1,3,true);CodeMirror.on(c,"clear",function(){b++});eqPos(a.getCursor(),Pos(3,0));a.setCursor(Pos(0,3));a.execCommand("goCharRight");eq(b,2)},{value:"abc\ndef\nghi\njkl"});testCM("hiddenLinesSelectAll",function(a){addDoc(a,4,20);foldLines(a,0,10);foldLines(a,11,20);CodeMirror.commands.selectAll(a);eqPos(a.getCursor(true),Pos(10,0));eqPos(a.getCursor(false),Pos(10,4))});testCM("everythingFolded",function(a){addDoc(a,2,2);function c(){a.triggerOnKeyDown({type:"keydown",keyCode:13,preventDefault:function(){},stopPropagation:function(){}})}var b=foldLines(a,0,2);c();eq(a.getValue(),"xx\nxx");b.clear();b=foldLines(a,0,2,true);eq(b.find(),null);c();eq(a.getValue(),"\nxx\nxx")});testCM("structuredFold",function(a){addDoc(a,4,8);var c=a.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q")});a.setCursor(0,3);CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),Pos(6,2));CodeMirror.commands.goCharLeft(a);eqPos(a.getCursor(),Pos(1,2));CodeMirror.commands.delCharAfter(a);eq(a.getValue(),"xxxx\nxxxx\nxxxx");addDoc(a,4,8);c=a.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("x"),clearOnEnter:true});var b=0;CodeMirror.on(c,"clear",function(){++b});a.setCursor(0,3);CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),Pos(6,2));CodeMirror.commands.goCharLeft(a);eqPos(a.getCursor(),Pos(6,1));eq(b,1);c.clear();eq(b,1);c=a.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q"),clearOnEnter:true});c.clear();a.setCursor(1,2);CodeMirror.commands.goCharRight(a);eqPos(a.getCursor(),Pos(1,3))},null);testCM("nestedFold",function(b){addDoc(b,10,3);function e(j,g,h,i){return b.markText(Pos(j,g),Pos(h,i),{collapsed:true})}var c=e(0,6,1,3),a=e(0,2,1,8),f=e(0,1,2,3),d=e(0,5,0,6);b.setCursor(0,1);CodeMirror.commands.goCharRight(b);eqPos(b.getCursor(),Pos(2,3));d.clear();CodeMirror.commands.goCharLeft(b);eqPos(b.getCursor(),Pos(0,1));f.clear();CodeMirror.commands.goCharRight(b);eqPos(b.getCursor(),Pos(0,2));CodeMirror.commands.goCharRight(b);eqPos(b.getCursor(),Pos(1,8));a.clear();CodeMirror.commands.goCharLeft(b);eqPos(b.getCursor(),Pos(1,7));b.setCursor(0,5);CodeMirror.commands.goCharRight(b);eqPos(b.getCursor(),Pos(0,6));CodeMirror.commands.goCharRight(b);eqPos(b.getCursor(),Pos(1,3))});testCM("badNestedFold",function(b){addDoc(b,4,4);b.markText(Pos(0,2),Pos(3,2),{collapsed:true});var a;try{b.markText(Pos(0,1),Pos(0,3),{collapsed:true})}catch(c){a=c}is(a instanceof Error,"no error");is(/overlap/i.test(a.message),"wrong error")});testCM("inlineWidget",function(a){var b=a.setBookmark(Pos(0,2),{widget:document.createTextNode("uu")});a.setCursor(0,2);CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),Pos(1,4));a.setCursor(0,2);a.replaceSelection("hi");eqPos(b.find(),Pos(0,2));a.setCursor(0,1);a.replaceSelection("ay");eqPos(b.find(),Pos(0,4));eq(a.getLine(0),"uayuhiuu")},{value:"uuuu\nuuuuuu"});testCM("wrappingAndResizing",function(a){a.setSize(null,"auto");a.setOption("lineWrapping",true);var d=a.getWrapperElement(),c=d.offsetHeight;var f="xxx xxx xxx xxx xxx";a.setValue(f);for(var e=10,b=a.charCoords(Pos(0,18),"div").right;;b+=e){a.setSize(b);if(d.offsetHeight<=c*(opera_lt10?1.2:1.5)){if(e==10){b-=10;e=1}else{break}}}a.setCursor(Pos(0,f.length));eq(d.offsetHeight,c);a.replaceSelection("x");is(d.offsetHeight>c,"wrapping happens");a.setValue(f+"\n"+f+"\n");a.getScrollerElement().style.maxHeight="100px";a.replaceRange("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n",Pos(2,0));forEach([Pos(0,f.length),Pos(0,f.length-1),Pos(0,0),Pos(1,f.length),Pos(1,f.length-1)],function(h){var g=a.charCoords(h);eqPos(h,a.coordsChar({left:g.left+2,top:g.top+5}))})},null,ie_lt8);testCM("measureEndOfLine",function(a){a.setSize(null,"auto");var d=byClassName(a.getWrapperElement(),"CodeMirror-lines")[0].firstChild;var c=d.offsetHeight;for(var f=10,b=a.charCoords(Pos(0,7),"div").right;;b+=f){a.setSize(b);if(d.offsetHeight<2.5*c){if(f==10){b-=10;f=1}else{break}}}a.setValue(a.getValue()+"\n\n");var e=a.charCoords(Pos(0,18),"local");is(e.top>c*0.8,"not at top");is(e.left>b-20,"not at right");e=a.charCoords(Pos(0,18));eqPos(a.coordsChar({left:e.left,top:e.top+5}),Pos(0,18))},{mode:"text/html",value:"<!-- foo barrr -->",lineWrapping:true},ie_lt8||opera_lt10);testCM("scrollVerticallyAndHorizontally",function(a){a.setSize(100,100);addDoc(a,40,40);a.setCursor(39);var b=a.getWrapperElement(),d=byClassName(b,"CodeMirror-vscrollbar")[0];is(d.offsetHeight<b.offsetHeight,"vertical scrollbar limited by horizontal one");var c=byClassName(b,"CodeMirror-cursor")[0].getBoundingClientRect();var e=b.getBoundingClientRect();is(c.bottom<e.top+a.getScrollerElement().clientHeight,"bottom line visible")},{lineNumbers:true});testCM("moveVstuck",function(a){var c=byClassName(a.getWrapperElement(),"CodeMirror-lines")[0].firstChild,d=c.offsetHeight;var e="fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n";a.setValue(e);for(var b=a.charCoords(Pos(0,26),"div").right*2.8;;b+=5){a.setSize(b);if(c.offsetHeight<=3.5*d){break}}a.setCursor(Pos(0,e.length-1));a.moveV(-1,"line");eqPos(a.getCursor(),Pos(0,26))},{lineWrapping:true},ie_lt8||opera_lt10);testCM("clickTab",function(a){var b=a.charCoords(Pos(0,0));eqPos(a.coordsChar({left:b.left+5,top:b.top+5}),Pos(0,0));eqPos(a.coordsChar({left:b.right-5,top:b.top+5}),Pos(0,1))},{value:"\t\n\n",lineWrapping:true,tabSize:8});testCM("verticalScroll",function(a){a.setSize(100,200);a.setValue("foo\nbar\nbaz\n");var d=a.getScrollerElement(),b=d.scrollWidth;a.setLine(0,"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah");is(d.scrollWidth>b,"scrollbar present");a.setLine(0,"foo");if(!phantom){eq(d.scrollWidth,b,"scrollbar gone")}a.setLine(0,"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah");a.setLine(1,"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh");is(d.scrollWidth>b,"present again");var c=d.scrollWidth;a.setLine(0,"foo");is(d.scrollWidth<c,"scrollbar smaller");is(d.scrollWidth>b,"but still present")});testCM("extraKeys",function(a){var c;function b(g,f,d){if(typeof f=="string"){f=f.charCodeAt(0)}var h={type:"keydown",keyCode:f,preventDefault:function(){},stopPropagation:function(){}};if(d){for(var i in d){h[i]=d[i]}}c=null;a.triggerOnKeyDown(h);eq(c,g)}CodeMirror.commands.testCommand=function(){c="tc"};CodeMirror.commands.goTestCommand=function(){c="gtc"};a.setOption("extraKeys",{"Shift-X":function(){c="sx"},X:function(){c="x"},"Ctrl-Alt-U":function(){c="cau"},End:"testCommand",Home:"goTestCommand",Tab:false});b(null,"U");b("cau","U",{ctrlKey:true,altKey:true});b(null,"U",{shiftKey:true,ctrlKey:true,altKey:true});b("x","X");b("sx","X",{shiftKey:true});b("tc",35);b(null,35,{shiftKey:true});b("gtc",36);b("gtc",36,{shiftKey:true});b(null,9)},null,window.opera&&mac);testCM("wordMovementCommands",function(a){a.execCommand("goWordLeft");eqPos(a.getCursor(),Pos(0,0));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),Pos(0,7));a.execCommand("goWordLeft");eqPos(a.getCursor(),Pos(0,5));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),Pos(0,12));a.execCommand("goWordLeft");eqPos(a.getCursor(),Pos(0,9));a.execCommand("goWordRight");a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),Pos(0,24));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),Pos(1,9));a.execCommand("goWordRight");eqPos(a.getCursor(),Pos(1,13));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),Pos(2,0))},{value:"this is (the) firstline.\na foo12\u00e9\u00f8\u00d7bar\n"});testCM("groupMovementCommands",function(a){a.execCommand("goGroupLeft");eqPos(a.getCursor(),Pos(0,0));a.execCommand("goGroupRight");eqPos(a.getCursor(),Pos(0,4));a.execCommand("goGroupRight");eqPos(a.getCursor(),Pos(0,7));a.execCommand("goGroupRight");eqPos(a.getCursor(),Pos(0,10));a.execCommand("goGroupLeft");eqPos(a.getCursor(),Pos(0,7));a.execCommand("goGroupRight");a.execCommand("goGroupRight");a.execCommand("goGroupRight");eqPos(a.getCursor(),Pos(0,15));a.setCursor(Pos(0,17));a.execCommand("goGroupLeft");eqPos(a.getCursor(),Pos(0,16));a.execCommand("goGroupLeft");eqPos(a.getCursor(),Pos(0,14));a.execCommand("goGroupRight");a.execCommand("goGroupRight");eqPos(a.getCursor(),Pos(0,20));a.execCommand("goGroupRight");eqPos(a.getCursor(),Pos(1,5));a.execCommand("goGroupLeft");a.execCommand("goGroupLeft");eqPos(a.getCursor(),Pos(1,0));a.execCommand("goGroupLeft");eqPos(a.getCursor(),Pos(0,16))},{value:"booo ba---quux. ffff\n  abc d"});testCM("charMovementCommands",function(a){a.execCommand("goCharLeft");a.execCommand("goColumnLeft");eqPos(a.getCursor(),Pos(0,0));a.execCommand("goCharRight");a.execCommand("goCharRight");eqPos(a.getCursor(),Pos(0,2));a.setCursor(Pos(1,0));a.execCommand("goColumnLeft");eqPos(a.getCursor(),Pos(1,0));a.execCommand("goCharLeft");eqPos(a.getCursor(),Pos(0,5));a.execCommand("goColumnRight");eqPos(a.getCursor(),Pos(0,5));a.execCommand("goCharRight");eqPos(a.getCursor(),Pos(1,0));a.execCommand("goLineEnd");eqPos(a.getCursor(),Pos(1,5));a.execCommand("goLineStartSmart");eqPos(a.getCursor(),Pos(1,1));a.execCommand("goLineStartSmart");eqPos(a.getCursor(),Pos(1,0));a.setCursor(Pos(2,0));a.execCommand("goCharRight");a.execCommand("goColumnRight");eqPos(a.getCursor(),Pos(2,0))},{value:"line1\n ine2\n"});testCM("verticalMovementCommands",function(a){a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(0,0));a.execCommand("goLineDown");if(!phantom){eqPos(a.getCursor(),Pos(1,0))}a.setCursor(Pos(1,12));a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(2,5));a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(3,0));a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(2,5));a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(1,12));a.execCommand("goPageDown");eqPos(a.getCursor(),Pos(5,0));a.execCommand("goPageDown");a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(5,0));a.execCommand("goPageUp");eqPos(a.getCursor(),Pos(0,0))},{value:"line1\nlong long line2\nline3\n\nline5\n"});testCM("verticalMovementCommandsWrapping",function(a){a.setSize(120);a.setCursor(Pos(0,5));a.execCommand("goLineDown");eq(a.getCursor().line,0);is(a.getCursor().ch>5,"moved beyond wrap");for(var b=0;;++b){is(b<20,"no endless loop");a.execCommand("goLineDown");var c=a.getCursor();if(c.line==1){eq(c.ch,5)}if(c.line==2){eq(c.ch,1);break}}},{value:"a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk",lineWrapping:true});testCM("rtlMovement",function(a){forEach(["خحج","خحabcخحج","abخحخحجcd","abخde","abخح2342خ1حج","خ1ح2خح3حxج","خحcd","1خحcd","abcdeح1ج","خمرحبها مها!","foobarر"],function(c){var b=c.charAt(0)=="خ";a.setValue(c+"\n");a.execCommand(b?"goLineEnd":"goLineStart");var g=byClassName(a.getWrapperElement(),"CodeMirror-cursor")[0];var f=g.offsetLeft,e=g.offsetTop;for(var d=0;d<=c.length;++d){a.execCommand("goCharRight");if(d==c.length){is(g.offsetTop>e,"next line")}else{is(g.offsetLeft>f,"moved right")}f=g.offsetLeft;e=g.offsetTop}a.setCursor(0,0);a.execCommand(b?"goLineStart":"goLineEnd");f=g.offsetLeft;for(var d=0;d<c.length;++d){a.execCommand("goCharLeft");is(g.offsetLeft<f,"moved left");f=g.offsetLeft}})},{rtlMoveVisually:true});testCM("bidiUpdate",function(a){a.setCursor(Pos(0,2));a.replaceSelection("خحج","start");a.execCommand("goCharRight");eqPos(a.getCursor(),Pos(0,4))},{value:"abcd\n"});testCM("movebyTextUnit",function(a){a.setValue("בְּרֵאשִ\ńéée\n");a.execCommand("goLineEnd");for(var b=0;b<4;++b){a.execCommand("goCharRight")}eqPos(a.getCursor(),Pos(0,0));a.execCommand("goCharRight");eqPos(a.getCursor(),Pos(1,0));a.execCommand("goCharRight");a.execCommand("goCharRight");eqPos(a.getCursor(),Pos(1,3));a.execCommand("goCharRight");a.execCommand("goCharRight");eqPos(a.getCursor(),Pos(1,6))});testCM("lineChangeEvents",function(a){addDoc(a,3,5);var c=[],d=["ch 0","ch 1","del 2","ch 0","ch 0","del 1","del 3","del 4"];for(var b=0;b<5;++b){CodeMirror.on(a.getLineHandle(b),"delete",function(e){return function(){c.push("del "+e)}}(b));CodeMirror.on(a.getLineHandle(b),"change",function(e){return function(){c.push("ch "+e)}}(b))}a.replaceRange("x",Pos(0,1));a.replaceRange("xy",Pos(1,1),Pos(2));a.replaceRange("foo\nbar",Pos(0,1));a.replaceRange("",Pos(0,0),Pos(a.lineCount()));eq(c.length,d.length,"same length");for(var b=0;b<c.length;++b){eq(c[b],d[b])}});testCM("scrollEntirelyToRight",function(a){if(phantom){return}addDoc(a,500,2);a.setCursor(Pos(0,500));var b=a.getWrapperElement(),c=byClassName(b,"CodeMirror-cursor")[0];is(b.getBoundingClientRect().right>c.getBoundingClientRect().left)});testCM("lineWidgets",function(a){addDoc(a,500,3);var c=a.charCoords(Pos(2,0));var b=document.createElement("div");b.innerHTML="hi";var d=a.addLineWidget(1,b);is(c.top<a.charCoords(Pos(2,0)).top,"took up space");a.setCursor(Pos(1,1));a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(2,1));a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(1,1))});testCM("lineWidgetFocus",function(a){var b=document.getElementById("testground");b.className="offscreen";try{addDoc(a,500,10);var c=document.createElement("input");var d=a.addLineWidget(1,c);c.focus();eq(document.activeElement,c);a.replaceRange("new stuff",Pos(1,0));eq(document.activeElement,c)}finally{b.className=""}});testCM("getLineNumber",function(a){addDoc(a,2,20);var b=a.getLineHandle(1);eq(a.getLineNumber(b),1);a.replaceRange("hi\nbye\n",Pos(0,0));eq(a.getLineNumber(b),3);a.setValue("");eq(a.getLineNumber(b),null)});testCM("jumpTheGap",function(a){var b="abcdef ghiklmnop qrstuvw xyz ";b+=b;b+=b;b+=b;a.setLine(2,b);a.setSize("200px",null);a.getWrapperElement().style.lineHeight=2;a.refresh();a.setCursor(Pos(0,1));a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(1,1));a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(2,1));a.execCommand("goLineDown");eq(a.getCursor().line,2);is(a.getCursor().ch>1);a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(2,1));a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(1,1));var c=document.createElement("div");c.innerHTML="hi";c.style.height="30px";a.addLineWidget(0,c);a.addLineWidget(1,c.cloneNode(true),{above:true});a.setCursor(Pos(0,2));a.execCommand("goLineDown");eqPos(a.getCursor(),Pos(1,2));a.execCommand("goLineUp");eqPos(a.getCursor(),Pos(0,2))},{lineWrapping:true,value:"abc\ndef\nghi\njkl\n"});testCM("addLineClass",function(a){function c(d,h,f,g){var e=a.lineInfo(d);eq(e.textClass,h);eq(e.bgClass,f);eq(e.wrapClass,g)}a.addLineClass(0,"text","foo");a.addLineClass(0,"text","bar");a.addLineClass(1,"background","baz");a.addLineClass(1,"wrap","foo");c(0,"foo bar",null,null);c(1,null,"baz","foo");var b=a.display.lineDiv;eq(byClassName(b,"foo").length,2);eq(byClassName(b,"bar").length,1);eq(byClassName(b,"baz").length,1);a.removeLineClass(0,"text","foo");c(0,"bar",null,null);a.removeLineClass(0,"text","foo");c(0,"bar",null,null);a.removeLineClass(0,"text","bar");c(0,null,null,null);a.addLineClass(1,"wrap","quux");c(1,null,"baz","foo quux");a.removeLineClass(1,"wrap");c(1,null,"baz",null)},{value:"hohoho\n"});testCM("atomicMarker",function(b){addDoc(b,10,10);function c(i,f,g,h,d,e){return b.markText(Pos(i,f),Pos(g,h),{atomic:true,inclusiveLeft:d,inclusiveRight:e})}var a=c(0,1,0,5);b.setCursor(Pos(0,1));b.execCommand("goCharRight");eqPos(b.getCursor(),Pos(0,5));b.execCommand("goCharLeft");eqPos(b.getCursor(),Pos(0,1));a.clear();a=c(0,0,0,5,true);eqPos(b.getCursor(),Pos(0,5),"pushed out");b.execCommand("goCharLeft");eqPos(b.getCursor(),Pos(0,5));a.clear();a=c(8,4,9,10,false,true);b.setCursor(Pos(9,8));eqPos(b.getCursor(),Pos(8,4),"set");b.execCommand("goCharRight");eqPos(b.getCursor(),Pos(8,4),"char right");b.execCommand("goLineDown");eqPos(b.getCursor(),Pos(8,4),"line down");b.execCommand("goCharLeft");eqPos(b.getCursor(),Pos(8,3));a.clear();a=c(1,1,3,8);b.setCursor(Pos(2,0));eqPos(b.getCursor(),Pos(3,8));b.execCommand("goCharLeft");eqPos(b.getCursor(),Pos(1,1));b.execCommand("goCharRight");eqPos(b.getCursor(),Pos(3,8));b.execCommand("goLineUp");eqPos(b.getCursor(),Pos(1,1));b.execCommand("goLineDown");eqPos(b.getCursor(),Pos(3,8));b.execCommand("delCharBefore");eq(b.getValue().length,80,"del chunk");a=c(3,0,5,5);b.setCursor(Pos(3,0));b.execCommand("delWordAfter");eq(b.getValue().length,53,"del chunk")});testCM("readOnlyMarker",function(b){function c(h,e,f,g,d){return b.markText(Pos(h,e),Pos(f,g),{readOnly:true,atomic:d})}var a=c(0,1,0,4);b.setCursor(Pos(0,2));b.replaceSelection("hi","end");eqPos(b.getCursor(),Pos(0,2));eq(b.getLine(0),"abcde");b.execCommand("selectAll");b.replaceSelection("oops");eq(b.getValue(),"oopsbcd");b.undo();eqPos(a.find().from,Pos(0,1));eqPos(a.find().to,Pos(0,4));a.clear();b.setCursor(Pos(0,2));b.replaceSelection("hi");eq(b.getLine(0),"abhicde");eqPos(b.getCursor(),Pos(0,4));a=c(0,2,2,2,true);b.setSelection(Pos(1,1),Pos(2,4));b.replaceSelection("t","end");eqPos(b.getCursor(),Pos(2,3));eq(b.getLine(2),"klto");b.execCommand("goCharLeft");b.execCommand("goCharLeft");eqPos(b.getCursor(),Pos(0,2));b.setSelection(Pos(0,1),Pos(0,3));b.replaceSelection("xx");eqPos(b.getCursor(),Pos(0,3));eq(b.getLine(0),"axxhicde")},{value:"abcde\nfghij\nklmno\n"});testCM("dirtyBit",function(a){eq(a.isClean(),true);a.replaceSelection("boo");eq(a.isClean(),false);a.undo();eq(a.isClean(),true);a.replaceSelection("boo");a.replaceSelection("baz");a.undo();eq(a.isClean(),false);a.markClean();eq(a.isClean(),true);a.undo();eq(a.isClean(),false);a.redo();eq(a.isClean(),true)});testCM("addKeyMap",function(a){function b(f){a.triggerOnKeyDown({type:"keydown",keyCode:f,preventDefault:function(){},stopPropagation:function(){}})}b(39);eqPos(a.getCursor(),Pos(0,1));var e=0;var d={Right:function(){++e}},c={Right:function(){e+=10}};a.addKeyMap(d);b(39);eqPos(a.getCursor(),Pos(0,1));eq(e,1);a.addKeyMap(c,true);b(39);eq(e,2);a.removeKeyMap(d);b(39);eq(e,12);a.removeKeyMap(c);b(39);eq(e,12);eqPos(a.getCursor(),Pos(0,2));a.addKeyMap({Right:function(){e=55},name:"mymap"});b(39);eq(e,55);a.removeKeyMap("mymap");b(39);eqPos(a.getCursor(),Pos(0,3))},{value:"abc"});testCM("findPosH",function(a){forEach([{from:Pos(0,0),to:Pos(0,1),by:1},{from:Pos(0,0),to:Pos(0,0),by:-1,hitSide:true},{from:Pos(0,0),to:Pos(0,4),by:1,unit:"word"},{from:Pos(0,0),to:Pos(0,8),by:2,unit:"word"},{from:Pos(0,0),to:Pos(2,0),by:20,unit:"word",hitSide:true},{from:Pos(0,7),to:Pos(0,5),by:-1,unit:"word"},{from:Pos(0,4),to:Pos(0,8),by:1,unit:"word"},{from:Pos(1,0),to:Pos(1,18),by:3,unit:"word"},{from:Pos(1,22),to:Pos(1,5),by:-3,unit:"word"},{from:Pos(1,15),to:Pos(1,10),by:-5},{from:Pos(1,15),to:Pos(1,10),by:-5,unit:"column"},{from:Pos(1,15),to:Pos(1,0),by:-50,unit:"column",hitSide:true},{from:Pos(1,15),to:Pos(1,24),by:50,unit:"column",hitSide:true},{from:Pos(1,15),to:Pos(2,0),by:50,hitSide:true}],function(b){var c=a.findPosH(b.from,b.by,b.unit||"char");eqPos(c,b.to);eq(!!c.hitSide,!!b.hitSide)})},{value:"line one\nline two.something.other\n"});testCM("beforeChange",function(a){a.on("beforeChange",function(b,e){var d=[];for(var c=0;c<e.text.length;++c){d.push(e.text[c].replace(/\s/g,"_"))}e.update(null,null,d)});a.setValue("hello, i am a\nnew document\n");eq(a.getValue(),"hello,_i_am_a\nnew_document\n");CodeMirror.on(a.getDoc(),"beforeChange",function(b,c){if(c.from.line==0){c.cancel()}});a.setValue("oops");eq(a.getValue(),"hello,_i_am_a\nnew_document\n");a.replaceRange("hey hey hey",Pos(1,0),Pos(2,0));eq(a.getValue(),"hello,_i_am_a\nhey_hey_hey")},{value:"abcdefghijk"});testCM("beforeSelectionChange",function(a){function b(d,e){var c=d.getLine(e.line).length;if(!c||e.ch==c){return Pos(e.line,e.ch-1)}return e}a.on("beforeSelectionChange",function(c,d){d.head=b(c,d.head);d.anchor=b(c,d.anchor)});addDoc(a,10,10);a.execCommand("goLineEnd");eqPos(a.getCursor(),Pos(0,9));a.execCommand("selectAll");eqPos(a.getCursor("start"),Pos(0,0));eqPos(a.getCursor("end"),Pos(9,9))});testCM("change_removedText",function(a){a.setValue("abc\ndef");var b;a.on("change",function(c,d){b=[d.removed,d.next&&d.next.removed]});a.operation(function(){a.replaceRange("xyz",Pos(0,0),Pos(1,1));a.replaceRange("123",Pos(0,0))});eq(b[0].join("\n"),"abc\nd");eq(b[1].join("\n"),"");a.undo();eq(b[0].join("\n"),"123");eq(b[1].join("\n"),"xyz");a.redo();eq(b[0].join("\n"),"abc\nd");eq(b[1].join("\n"),"")});