// plugin.js
tinymce.PluginManager.add("fullpage",function(d){var j=tinymce.each,f=tinymce.html.Node;var h,k;function i(){var m=l();d.windowManager.open({title:"Document properties",data:m,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(n){g(tinymce.extend(m,n.data))}})}function l(){var n=e(),p={},q,o;function m(t,r){var s=t.attr(r);return s||""}p.fontface=d.getParam("fullpage_default_fontface","");p.fontsize=d.getParam("fullpage_default_fontsize","");q=n.firstChild;if(q.type==7){p.xml_pi=true;o=/encoding="([^"]+)"/.exec(q.value);if(o){p.docencoding=o[1]}}q=n.getAll("#doctype")[0];if(q){p.doctype="<!DOCTYPE"+q.value+">"}q=n.getAll("title")[0];if(q&&q.firstChild){p.title=q.firstChild.value}j(n.getAll("meta"),function(u){var s=u.attr("name"),r=u.attr("http-equiv"),t;if(s){p[s.toLowerCase()]=u.attr("content")}else{if(r=="Content-Type"){t=/charset\s*=\s*(.*)\s*/gi.exec(u.attr("content"));if(t){p.docencoding=t[1]}}}});q=n.getAll("html")[0];if(q){p.langcode=m(q,"lang")||m(q,"xml:lang")}q=n.getAll("link")[0];if(q&&q.attr("rel")=="stylesheet"){p.stylesheet=q.attr("href")}q=n.getAll("body")[0];if(q){p.langdir=m(q,"dir");p.style=m(q,"style");p.visited_color=m(q,"vlink");p.link_color=m(q,"link");p.active_color=m(q,"alink")}return p}function g(q){var p,n,r,t,u,o=d.dom;function m(x,v,w){x.attr(v,w?w:undefined)}function s(v){if(n.firstChild){n.insert(v,n.firstChild)}else{n.append(v)}}p=e();n=p.getAll("head")[0];if(!n){t=p.getAll("html")[0];n=new f("head",1);if(t.firstChild){t.insert(n,t.firstChild,true)}else{t.append(n)}}t=p.firstChild;if(q.xml_pi){u='version="1.0"';if(q.docencoding){u+=' encoding="'+q.docencoding+'"'}if(t.type!=7){t=new f("xml",7);p.insert(t,p.firstChild,true)}t.value=u}else{if(t&&t.type==7){t.remove()}}t=p.getAll("#doctype")[0];if(q.doctype){if(!t){t=new f("#doctype",10);if(q.xml_pi){p.insert(t,p.firstChild)}else{s(t)}}t.value=q.doctype.substring(9,q.doctype.length-1)}else{if(t){t.remove()}}if(q.docencoding){t=null;j(p.getAll("meta"),function(v){if(v.attr("http-equiv")=="Content-Type"){t=v}});if(!t){t=new f("meta",1);t.attr("http-equiv","Content-Type");t.shortEnded=true;s(t)}t.attr("content","text/html; charset="+q.docencoding)}t=p.getAll("title")[0];if(q.title){if(!t){t=new f("title",1);t.append(new f("#text",3)).value=q.title;s(t)}}else{if(t){t.remove()}}j("keywords,description,author,copyright,robots".split(","),function(w){var v=p.getAll("meta"),x,z,y=q[w];for(x=0;x<v.length;x++){z=v[x];if(z.attr("name")==w){if(y){z.attr("content",y)}else{z.remove()}return}}if(y){t=new f("meta",1);t.attr("name",w);t.attr("content",y);t.shortEnded=true;s(t)}});t=p.getAll("link")[0];if(t&&t.attr("rel")=="stylesheet"){if(q.stylesheet){t.attr("href",q.stylesheet)}else{t.remove()}}else{if(q.stylesheet){t=new f("link",1);t.attr({rel:"stylesheet",text:"text/css",href:q.stylesheet});t.shortEnded=true;s(t)}}t=p.getAll("body")[0];if(t){m(t,"dir",q.langdir);m(t,"style",q.style);m(t,"vlink",q.visited_color);m(t,"link",q.link_color);m(t,"alink",q.active_color);o.setAttribs(d.getBody(),{style:q.style,dir:q.dir,vLink:q.visited_color,link:q.link_color,aLink:q.active_color})}t=p.getAll("html")[0];if(t){m(t,"lang",q.langcode);m(t,"xml:lang",q.langcode)}if(!n.firstChild){n.remove()}r=new tinymce.html.Serializer({validate:false,indent:true,apply_source_formatting:true,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(p);h=r.substring(0,r.indexOf("</body>"))}function e(){return new tinymce.html.DomParser({validate:false,root_name:"#document"}).parse(h)}function b(n){var s,m,r=n.content,q,v="",p=d.dom,t;function u(o){return o.replace(/<\/?[A-Z]+/g,function(w){return w.toLowerCase()})}if(n.format=="raw"&&h){return}if(n.source_view&&d.getParam("fullpage_hide_in_source_view")){return}r=r.replace(/<(\/?)BODY/gi,"<$1body");s=r.indexOf("<body");if(s!=-1){s=r.indexOf(">",s);h=u(r.substring(0,s+1));m=r.indexOf("</body",s);if(m==-1){m=r.length}n.content=r.substring(s+1,m);k=u(r.substring(m))}else{h=a();k="\n</body>\n</html>"}q=e();j(q.getAll("style"),function(o){if(o.firstChild){v+=o.firstChild.value}});t=q.getAll("body")[0];if(t){p.setAttribs(d.getBody(),{style:t.attr("style")||"",dir:t.attr("dir")||"",vLink:t.attr("vlink")||"",link:t.attr("link")||"",aLink:t.attr("alink")||""})}p.remove("fullpage_styles");if(v){p.add(d.getDoc().getElementsByTagName("head")[0],"style",{id:"fullpage_styles"},v);t=p.get("fullpage_styles");if(t.styleSheet){t.styleSheet.cssText=v}}}function a(){var o="",n,m="";if(d.getParam("fullpage_default_xml_pi")){o+='<?xml version="1.0" encoding="'+d.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'}o+=d.getParam("fullpage_default_doctype","<!DOCTYPE html>");o+="\n<html>\n<head>\n";if((n=d.getParam("fullpage_default_title"))){o+="<title>"+n+"</title>\n"}if((n=d.getParam("fullpage_default_encoding"))){o+='<meta http-equiv="Content-Type" content="text/html; charset='+n+'" />\n'}if((n=d.getParam("fullpage_default_font_family"))){m+="font-family: "+n+";"}if((n=d.getParam("fullpage_default_font_size"))){m+="font-size: "+n+";"}if((n=d.getParam("fullpage_default_text_color"))){m+="color: "+n+";"}o+="</head>\n<body"+(m?' style="'+m+'"':"")+">\n";return o}function c(m){if(!m.selection&&(!m.source_view||!d.getParam("fullpage_hide_in_source_view"))){m.content=tinymce.trim(h)+"\n"+tinymce.trim(m.content)+"\n"+tinymce.trim(k)}}d.addCommand("mceFullPageProperties",i);d.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"});d.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"});d.on("BeforeSetContent",b);d.on("GetContent",c)});