// plugin.js
tinymce.PluginManager.add("media",function(d,b){var i=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];function a(k){if(k.indexOf(".mp3")!=-1){return"audio/mpeg"}if(k.indexOf(".wav")!=-1){return"audio/wav"}if(k.indexOf(".mp4")!=-1){return"video/mp4"}if(k.indexOf(".webm")!=-1){return"video/webm"}if(k.indexOf(".ogg")!=-1){return"video/ogg"}return""}function h(){var o,m,k,n;function l(t){var q,s,r,p;q=o.find("#width")[0];s=o.find("#height")[0];r=q.value();p=s.value();if(o.find("#constrain")[0].checked()&&m&&k&&r&&p){if(t.control==q){p=Math.round((r/m)*p);s.value(p)}else{r=Math.round((p/k)*r);q.value(r)}}m=r;k=p}n=c(d.selection.getNode());m=n.width;k=n.height;o=d.windowManager.open({title:"Insert/edit video",data:n,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){this.fromJSON(j(this.next().find("#embed").value()))},items:[{name:"source1",type:"filepicker",filetype:"image",size:40,autofocus:true,label:"Source"},{name:"source2",type:"filepicker",filetype:"image",size:40,label:"Alternative source"},{name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:l},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:l},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]}]},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(g(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:"},{type:"textbox",flex:1,name:"embed",value:e(),multiline:true,label:"Source"}]}],onSubmit:function(){d.insertContent(g(this.toJSON()))}})}function e(){var k=d.selection.getNode();if(k.getAttribute("data-mce-object")){return d.selection.getContent()}}function g(l){var k="";if(!l.source1){tinymce.extend(l,j(l.embed));if(!l.source1){return""}}l.source1=d.convertURL(l.source1,"source");l.source2=d.convertURL(l.source2,"source");l.source1mime=a(l.source1);l.source2mime=a(l.source2);l.poster=d.convertURL(l.poster,"poster");l.flashPlayerUrl=d.convertURL(b+"/moxieplayer.swf","movie");if(l.embed){k=f(l.embed,l,true)}else{tinymce.each(i,function(p){var n,o,m;if((n=p.regex.exec(l.source1))){m=p.url;for(o=0;n[o];o++){m=m.replace("$"+o,function(){return n[o]})}l.source1=m;l.type=p.type;l.width=p.w;l.height=p.h}});l.width=l.width||300;l.height=l.height||150;tinymce.each(l,function(n,m){l[m]=d.dom.encode(n)});if(l.type=="iframe"){k+='<iframe src="'+l.source1+'" width="'+l.width+'" height="'+l.height+'"></iframe>'}else{if(l.source1mime.indexOf("audio")!=-1){if(d.settings.audio_template_callback){k=d.settings.audio_template_callback(l)}else{k+=('<audio controls="controls" src="'+l.source1+'">'+(l.source2?'\n<source src="'+l.source2+'"'+(l.source2mime?' type="'+l.source2mime+'"':"")+" />\n":"")+"</audio>")}}else{if(d.settings.video_template_callback){k=d.settings.video_template_callback(l)}else{k=('<video width="'+l.width+'" height="'+l.height+'"'+(l.poster?' poster="'+l.poster+'"':"")+' controls="controls">\n<source src="'+l.source1+'"'+(l.source1mime?' type="'+l.source1mime+'"':"")+" />\n"+(l.source2?'<source src="'+l.source2+'"'+(l.source2mime?' type="'+l.source2mime+'"':"")+" />\n":"")+"</video>")}}}}return k}function j(k){var l={};new tinymce.html.SaxParser({validate:false,special:"script,noscript",start:function(n,m){if(!l.source1&&n=="param"){l.source1=m.map.movie}if(n=="iframe"||n=="object"||n=="embed"||n=="video"||n=="audio"){l=tinymce.extend(m.map,l)}if(n=="source"){if(!l.source1){l.source1=m.map.src}else{if(!l.source2){l.source2=m.map.src}}}}}).parse(k);l.source1=l.source1||l.src||l.data;l.source2=l.source2||"";l.poster=l.poster||"";return l}function c(k){if(k.getAttribute("data-mce-object")){return j(d.serializer.serialize(k,{selection:true}))}return{}}function f(m,o,p){var n=new tinymce.html.Writer();var l=0;function k(s,v){var r,t,u,q;for(r in v){u=""+v[r];if(s.map[r]){t=s.length;while(t--){q=s[t];if(q.name==r){if(u){s.map[r]=u;q.value=u}else{delete s.map[r];s.splice(t,1)}}}}else{if(u){s.push({name:r,value:u});s.map[r]=u}}}}new tinymce.html.SaxParser({validate:false,special:"script,noscript",comment:function(q){n.comment(q)},cdata:function(q){n.cdata(q)},text:function(r,q){n.text(r,q)},start:function(r,q,s){switch(r){case"video":case"object":case"img":case"iframe":k(q,{width:o.width,height:o.height});break}if(p){switch(r){case"video":k(q,{poster:o.poster,src:""});if(o.source2){k(q,{src:""})}break;case"iframe":k(q,{src:o.source1});break;case"source":l++;if(l<=2){k(q,{src:o["source"+l],type:o["source"+l+"mime"]});if(!o["source"+l]){return}}break}}n.start(r,q,s)},end:function(s){if(s=="video"&&p){for(var r=1;r<=2;r++){if(o["source"+r]){var q=[];q.map={};if(l<r){k(q,{src:o["source"+r],type:o["source"+r+"mime"]});n.start("source",q,true)}}}}n.end(s)}},new tinymce.html.Schema({})).parse(m);return n.getContent()}d.on("ResolveName",function(l){var k;if((k=l.target.getAttribute("data-mce-object"))){l.name=k}});d.on("preInit",function(){var k=d.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(m){k[m]=new RegExp("</"+m+"[^>]*>","gi")});d.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var l=d.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(m){l[m]={}});d.parser.addNodeFilter("iframe,video,audio,object,embed",function(o,n){var r=o.length,u,q,v,t,s,m,p;while(r--){q=o[r];v=new tinymce.html.Node("img",1);v.shortEnded=true;m=q.attributes;u=m.length;while(u--){t=m[u].name;s=m[u].value;if(t!=="width"&&t!=="height"&&t!=="style"){if(t=="data"||t=="src"){s=d.convertURL(s,t)}v.attr("data-mce-p-"+t,s)}}p=q.firstChild&&q.firstChild.value;if(p){v.attr("data-mce-html",escape(p));v.firstChild=null}v.attr({width:q.attr("width")||"300",height:q.attr("height")||(n=="audio"?"30":"150"),style:q.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":n,"class":"mce-object mce-object-"+n});q.replace(v)}});d.serializer.addAttributeFilter("data-mce-object",function(o,n){var r=o.length,q,u,t,m,p,v;while(r--){q=o[r];u=new tinymce.html.Node(q.attr(n),1);if(q.attr(n)!="audio"){u.attr({width:q.attr("width"),height:q.attr("height")})}u.attr({style:q.attr("style")});m=q.attributes;t=m.length;while(t--){var s=m[t].name;if(s.indexOf("data-mce-p-")===0){u.attr(s.substr(11),m[t].value)}}p=q.attr("data-mce-html");if(p){v=new tinymce.html.Node("#text",3);v.raw=true;v.value=unescape(p);u.append(v)}q.replace(u)}})});d.on("ObjectSelected",function(k){if(k.target.getAttribute("data-mce-object")=="audio"){k.preventDefault()}});d.on("objectResized",function(m){var l=m.target,k;if(l.getAttribute("data-mce-object")){k=l.getAttribute("data-mce-html");if(k){k=unescape(k);l.setAttribute("data-mce-html",escape(f(k,{width:m.width,height:m.height})))}}});d.addButton("media",{tooltip:"Insert/edit video",onclick:h,stateSelector:"img[data-mce-object=video]"});d.addMenuItem("media",{icon:"media",text:"Insert video",onclick:h,context:"insert",prependToContext:true})});