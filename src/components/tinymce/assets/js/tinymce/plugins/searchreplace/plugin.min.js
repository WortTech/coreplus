// plugin.js
(function(){function b(n,f,c,t,h){var g,i=[],s,l=0,o;var r,d,k;o=f.ownerDocument;r=h.getBlockElements();d=h.getWhiteSpaceElements();k=h.getShortEndedElements();function p(u,v){v=v||0;if(!u[0]){throw"findAndReplaceDOMText cannot handle zero-length matches"}var w=u.index;if(v>0){var x=u[v];if(!x){throw"Invalid capture group"}w+=u[0].indexOf(x);u[0]=x}return[w,w+u[0].length,[u[0]]]}function q(u){var m;if(u.nodeType===3){return u.data}if(d[u.nodeName]){return""}m="";if(r[u.nodeName]||k[u.nodeName]){m+="\n"}if((u=u.firstChild)){do{m+=q(u)}while((u=u.nextSibling))}return m}function j(w,y,C){var u,B,z,v,D=[],A=0,x=w,m=y.shift(),E=0;out:while(true){if(r[x.nodeName]||k[x.nodeName]){A++}if(x.nodeType===3){if(!B&&x.length+A>=m[1]){B=x;v=m[1]-A}else{if(u){D.push(x)}}if(!u&&x.length+A>m[0]){u=x;z=m[0]-A}A+=x.length}if(u&&B){x=C({startNode:u,startNodeIndex:z,endNode:B,endNodeIndex:v,innerNodes:D,match:m[2],matchIndex:E});A-=(B.length-v);u=null;B=null;D=[];m=y.shift();E++;if(!m){break}}else{if(!d[x.nodeName]&&x.firstChild){x=x.firstChild;continue}else{if(x.nextSibling){x=x.nextSibling;continue}}}while(true){if(x.nextSibling){x=x.nextSibling;break}else{if(x.parentNode!==w){x=x.parentNode}else{break out}}}}}function e(w){var m;if(typeof w!="function"){var v=w.nodeType?w:o.createElement(w);m=function(y,x){var z=v.cloneNode(false);z.setAttribute("data-mce-index",x);if(y){z.appendChild(o.createTextNode(y))}return z}}else{m=w}return function u(D){var K,x,E,z=D.startNode,G=D.endNode,L=D.matchIndex;if(z===G){var A=z;E=A.parentNode;if(D.startNodeIndex>0){K=o.createTextNode(A.data.substring(0,D.startNodeIndex));E.insertBefore(K,A)}var y=m(D.match[0],L);E.insertBefore(y,A);if(D.endNodeIndex<A.length){x=o.createTextNode(A.data.substring(D.endNodeIndex));E.insertBefore(x,A)}A.parentNode.removeChild(A);return y}else{K=o.createTextNode(z.data.substring(0,D.startNodeIndex));x=o.createTextNode(G.data.substring(D.endNodeIndex));var I=m(z.data.substring(D.startNodeIndex),L);var H=[];for(var C=0,B=D.innerNodes.length;C<B;++C){var M=D.innerNodes[C];var J=m(M.data,L);M.parentNode.replaceChild(J,M);H.push(J)}var F=m(G.data.substring(0,D.endNodeIndex),L);E=z.parentNode;E.insertBefore(K,z);E.insertBefore(I,z);E.removeChild(z);E=G.parentNode;E.insertBefore(F,G);E.insertBefore(x,G);E.removeChild(G);return F}}}s=q(f);if(!s){return}if(n.global){while((g=n.exec(s))){i.push(p(g,t))}}else{g=s.match(n);i.push(p(g,t))}if(i.length){l=i.length;j(f,i,e(c))}return l}function a(h){var f=this,e=-1,g;function d(){var k=tinymce.ui.Factory.create({type:"window",layout:"flex",pack:"center",align:"center",onClose:function(){h.focus();g=false;f.unmarkAllMatches()},buttons:[{text:"Find",onclick:function(){k.find("form")[0].submit()}},{text:"Replace",disabled:true,onclick:function(){if(!f.replace(k.find("#replace").value())){k.statusbar.items().slice(1).disabled(true)}}},{text:"Replace all",disabled:true,onclick:function(){f.replaceAll(k.find("#replace").value());k.statusbar.items().slice(1).disabled(true)}},{type:"spacer",flex:1},{text:"Prev",disabled:true,onclick:function(){f.prev()}},{text:"Next",disabled:true,onclick:function(){f.next()}}],title:"Find and replace",items:{type:"form",padding:20,labelGap:30,spacing:10,onsubmit:function(p){var n,o,l,q,m;p.preventDefault();l=k.find("#case").checked();m=k.find("#words").checked();q=k.find("#find").value();if(!q.length){f.unmarkAllMatches();k.statusbar.items().slice(1).disabled(true);return}q=q.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");q=m?"\\b"+q+"\\b":q;o=new RegExp(q,l?"g":"gi");n=f.markAllMatches(o);if(n){f.first()}else{tinymce.ui.MessageBox.alert("Could not find the specified string.")}k.statusbar.items().slice(1).disabled(n===0)},items:[{type:"textbox",name:"find",size:40,label:"Find",value:h.selection.getNode().src},{type:"textbox",name:"replace",size:40,label:"Replace with"},{type:"checkbox",name:"case",text:"Match case",label:" "},{type:"checkbox",name:"words",text:"Whole words",label:" "}]}}).renderTo().reflow();g=true}f.init=function(k){k.addMenuItem("searchreplace",{text:"Find and replace",shortcut:"Ctrl+F",onclick:d,separator:"before",context:"edit"});k.addButton("searchreplace",{tooltip:"Find and replace",shortcut:"Ctrl+F",onclick:d});k.shortcuts.add("Ctrl+F","",d)};f.markAllMatches=function(m){var l,k;k=h.dom.create("span",{"class":"mce-match-marker","data-mce-bogus":1});l=h.getBody();f.unmarkAllMatches(l);return b(m,l,k,false,h.schema)};function c(l){var k=l.parentNode;k.insertBefore(l.firstChild,l);l.parentNode.removeChild(l)}function i(o,m){var p=h.selection,l=p.getRng(true),k=-1,q,r;o=o!==false;function n(){var s,t;if(m){s=h.getBody()[o?"firstChild":"lastChild"]}else{s=l[o?"endContainer":"startContainer"]}t=new tinymce.dom.TreeWalker(s,h.getBody());while((s=t.current())){if(s.nodeType==1&&s.nodeName=="SPAN"&&s.getAttribute("data-mce-index")!==null){k=s.getAttribute("data-mce-index");q=s.firstChild;while((s=t.current())){if(s.nodeType==1&&s.nodeName=="SPAN"&&s.getAttribute("data-mce-index")!==null){if(s.getAttribute("data-mce-index")===k){r=s.firstChild}else{return}}t[o?"next":"prev"]()}}t[o?"next":"prev"]()}}n();if(q&&r){h.focus();if(o){l.setStart(q,0);l.setEnd(r,r.length)}else{l.setStart(r,0);l.setEnd(q,q.length)}p.scrollIntoView(q.parentNode);p.setRng(l)}return k}function j(k){k.parentNode.removeChild(k)}f.first=function(){e=i(true,true);return e!==-1};f.next=function(){e=i(true);return e!==-1};f.prev=function(){e=i(false);return e!==-1};f.replace=function(t,q,s){var o,k,l,r,n,p;if(e===-1){e=i(q)}p=i(q);l=h.getBody();k=tinymce.toArray(l.getElementsByTagName("span"));if(k.length){for(o=0;o<k.length;o++){var m=k[o].getAttribute("data-mce-index");if(m===null||!m.length){continue}r=n=k[o].getAttribute("data-mce-index");if(s||r===e){if(t.length){k[o].firstChild.nodeValue=t;c(k[o])}else{j(k[o])}while(k[++o]){r=k[o].getAttribute("data-mce-index");if(m===null||!m.length){continue}if(r===n){j(k[o])}else{o--;break}}}}}if(p==-1){p=i(q,true)}e=p;if(s){h.selection.setCursorLocation(h.getBody(),0)}h.undoManager.add();return e!==-1};f.replaceAll=function(k){f.replace(k,true,true)};f.unmarkAllMatches=function(){var l,k,m;m=h.getBody();k=m.getElementsByTagName("span");l=k.length;while(l--){m=k[l];if(m.getAttribute("data-mce-index")){c(m)}}};h.on("beforeaddundo keydown",function(k){if(g){k.preventDefault();return false}})}tinymce.PluginManager.add("searchreplace",a)})();