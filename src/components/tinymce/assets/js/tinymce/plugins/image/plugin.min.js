// plugin.js
tinymce.PluginManager.add("image",function(b){function a(){var i,h,g=b.dom,j=b.selection.getNode();var c,m,k;function l(){var p=[{text:"None",value:""}];tinymce.each(b.settings.image_list,function(q){p.push({text:q.text||q.title,value:q.value||q.url,menu:q.menu})});return p}function e(t){var q,s,r,p;q=i.find("#width")[0];s=i.find("#height")[0];r=q.value();p=s.value();if(i.find("#constrain")[0].checked()&&c&&m&&r&&p){if(t.control==q){p=Math.round((r/c)*p);s.value(p)}else{r=Math.round((p/m)*r);q.value(r)}}c=r;m=p}function f(){function p(r){r.onload=r.onerror=function(){r.onload=r.onerror=null;b.selection.select(r);b.nodeChanged()}}var q=i.toJSON();if(q.width===""){q.width=null}if(q.height===""){q.height=null}if(q.style===""){q.style=null}q={src:q.src,alt:q.alt,width:q.width,height:q.height,style:q.style};if(!j){q.id="__mcenew";b.insertContent(g.createHTML("img",q));j=g.get("__mcenew");g.setAttrib(j,"id",null)}else{g.setAttribs(j,q)}p(j)}function o(p){if(p){p=p.replace(/px$/,"")}return p}c=g.getAttrib(j,"width");m=g.getAttrib(j,"height");if(j.nodeName=="IMG"&&!j.getAttribute("data-mce-object")){h={src:g.getAttrib(j,"src"),alt:g.getAttrib(j,"alt"),width:c,height:m}}else{j=null}if(b.settings.image_list){k={name:"target",type:"listbox",label:"Image list",values:l(),onselect:function(p){var q=i.find("#alt");if(!q.value()||(p.lastControl&&q.value()==p.lastControl.text())){q.value(p.control.text())}i.find("#src").value(p.control.value())}}}var d=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true},k,{name:"alt",type:"textbox",label:"Image description"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:e},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:e},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]}];function n(){function r(s){if(s.length>0&&/^[0-9]+$/.test(s)){s+="px"}return s}var q=i.toJSON();var p=g.parseStyle(q.style);delete p.margin;p["margin-top"]=p["margin-bottom"]=r(q.vspace);p["margin-left"]=p["margin-right"]=r(q.hspace);p["border-width"]=r(q.border);i.find("#style").value(g.serializeStyle(g.parseStyle(g.serializeStyle(p))))}if(b.settings.image_advtab){if(j){h.hspace=o(j.style.marginLeft||j.style.marginRight);h.vspace=o(j.style.marginTop||j.style.marginBottom);h.border=o(j.style.borderWidth);h.style=b.dom.serializeStyle(b.dom.parseStyle(b.dom.getAttrib(j,"style")))}i=b.windowManager.open({title:"Edit image",data:h,bodyType:"tabpanel",body:[{title:"General",type:"form",items:d},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:n},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:f})}else{i=b.windowManager.open({title:"Edit image",data:h,body:d,onSubmit:f})}}b.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:a,stateSelector:"img:not([data-mce-object])"});b.addMenuItem("image",{icon:"image",text:"Insert image",onclick:a,context:"insert",prependToContext:true})});