// plugin.js
tinymce.PluginManager.add("autosave",function(i){var d=i.settings,j=tinymce.util.LocalStorage,g=i.id,m;function a(q,o){var p={s:1000,m:60000};q=/^(\d+)([ms]?)$/.exec(""+(q||o));return(q[2]?p[q[2]]:1)*parseInt(q,10)}function c(){var o=parseInt(j.getItem(g+"autosave.time"),10)||0;if(new Date().getTime()-o>d.autosave_retention){n();return false}return true}function n(){j.removeItem(g+"autosave.draft");j.removeItem(g+"autosave.time")}function b(){if(m&&i.isDirty()){j.setItem(g+"autosave.draft",i.getContent({format:"raw",no_events:true}));j.setItem(g+"autosave.time",new Date().getTime());i.fire("StoreDraft")}}function l(){if(c()){i.setContent(j.getItem(g+"autosave.draft"),{format:"raw"});n();i.fire("RestoreDraft")}}function f(){if(!m){setInterval(function(){if(!i.removed){b()}},d.autosave_interval);m=true}}d.autosave_interval=a(d.autosave_interval,"30s");d.autosave_retention=a(d.autosave_retention,"20m");function h(){var o=this;o.disabled(!c());i.on("StoreDraft RestoreDraft",function(){o.disabled(!c())});f()}function e(){i.undoManager.beforeChange();l();i.undoManager.add()}i.addButton("restoredraft",{title:"Restore last draft",onclick:e,onPostRender:h});i.addMenuItem("restoredraft",{text:"Restore last draft",onclick:e,onPostRender:h,context:"file"});this.storeDraft=b;function k(){var o;tinymce.each(tinymce.editors,function(p){if(p.plugins.autosave){p.plugins.autosave.storeDraft()}if(!o&&p.isDirty()&&p.getParam("autosave_ask_before_unload",true)){o=p.translate("You have unsaved changes are you sure you want to navigate away?")}});return o}window.onbeforeunload=k});